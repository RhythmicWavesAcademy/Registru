<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>Add class attendance</title>
</head>
<body>

<div id="not_loggedIn_container" style="display: none;">
    <h1> Not logged in</h1>
    <h2> Please <a href="../index.html">log in</a></h2>
</div>

<div id="admin_logged_in_container" style="display: none;">
    <h2 id="class_attendance_title"> Add class attendance </h2>
    <form id="class_attendance_form" action="javascript:void(0);" method="post">
        <div class="form-group">
            <label>Children Name</label>
            <select name="children_attendance_children_id" id="children_attendance_children_id"></select><br/>
            <label>Class activity</label>
            <select name="children_attendance_class_activity" id="children_attendance_class_activity"></select><br/>
            <label for="children_attendance_present">Is present?</label>
            <input type="radio" id="children_attendance_present" name="children_attendance_present" value="true"><br/>
            <label for="children_attendance_datetime">Attendance date</label>
            <input type="datetime-local" id="children_attendance_datetime" name="children_attendance_datetime"><br/>
            <label for="children_attendance_should_pay">Should pay?</label>
            <input type="radio" id="children_attendance_should_pay" name="children_attendance_should_pay"
                   value="true"><br/>

            <input type="submit" value="Add class attendance" id="submit_class_attendance">
        </div>
    </form>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import {getFirestore} from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
    import {
        collection,
        getDocs,
        query,
        where,
        addDoc,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    import {
        getAuth,
        onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";

    window.onload = async () => {
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        const firebaseConfig = {
            apiKey: "AIzaSyAyW28VvX1hcNjPS49woHkUFaj8-cXMRps",
            authDomain: "registru-d6b7b.firebaseapp.com",
            projectId: "registru-d6b7b",
            storageBucket: "registru-d6b7b.firebasestorage.app",
            messagingSenderId: "914926288060",
            appId: "1:914926288060:web:5a085a2369b1a7ac7164b9",
            measurementId: "G-QSDZCKE9MR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const adminLoggedInContainer = document.getElementById("admin_logged_in_container");
        const notLoggedInContainer = document.getElementById("not_loggedIn_container");

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties

                const foundUsers = query(collection(db, "users"), where("auth_id", "==", user.uid));
                const querySnapshot = await getDocs(foundUsers);
                const firstUser = querySnapshot.docs[0].data();

                if (firstUser.user_type == "admin") {
                    adminLoggedInContainer.style.display = "block";
                    await onAdminAuthenticated();
                } else {
                    notLoggedInContainer.style.display = "block";
                }

            } else {
                // User is signed out
                notLoggedInContainer.style.display = "block";
            }
        });

        async function onAdminAuthenticated() {
            await populateFormWithData();
        }

        document.getElementById("submit_class_attendance").addEventListener("click", addClassAttendance, false);

        async function addClassAttendance() {
            const childrenId = document.querySelector("#children_attendance_children_id");
            const attendanceId = document.querySelector("#children_attendance_class_activity");
            const isPresent = document.querySelector("#children_attendance_present");
            const shouldPay = document.querySelector("#children_attendance_should_pay");
            const dateTimeInput = document.querySelector("#children_attendance_datetime");

            const docRef = await addDoc(collection(db, "attendance"), {
                children_id: childrenId.value,
                class_activity_id: attendanceId.value,
                is_present: isPresent.checked,
                should_pay: shouldPay.checked,
                present_at: dateTimeInput.value,
                created_at: serverTimestamp()
            });

            document.getElementById("class_attendance_title").innerHTML = "Added class attendance with id=" + docRef.id
            childrenId.value = "";
            attendanceId.value = "";
            isPresent.checked = false;
            shouldPay.checked = false;
            dateTimeInput.value = toLocalISOString(new Date());
        }

        function toLocalISOString(date) {
            const localDate = new Date(date - date.getTimezoneOffset() * 60000);
            localDate.setSeconds(null);
            localDate.setMilliseconds(null);
            return localDate.toISOString().slice(0, -1);
        }

        async function populateFormWithData() {
            document.getElementById('children_attendance_datetime').value = toLocalISOString(new Date());

            const attendanceChildrenId = document.getElementById("children_attendance_children_id");
            const querySnapshotChildren = await getDocs(collection(db, "children"));
            const querySnapshotClassActivity = await getDocs(collection(db, "class_activity"));

            for (let childrenDocument of querySnapshotChildren.docs) {
                const data = childrenDocument.data();

                attendanceChildrenId.insertAdjacentHTML('beforeend', '<option value=' + childrenDocument.id + '>' + data.first_name + " " + data.last_name + '</option>');

            }
            const attendanceClassActivity = document.getElementById("children_attendance_class_activity");
            for (let classActivityDocument of querySnapshotClassActivity.docs) {
                const data = classActivityDocument.data();

                attendanceClassActivity.insertAdjacentHTML('beforeend', '<option value=' + classActivityDocument.id + '>' + data.name + '</option>');
            }
        }
    };
</script>
</body>
</html>