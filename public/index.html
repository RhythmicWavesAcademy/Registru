<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript" src="js/app_config.js"></script>
    <script type="importmap">
        {
          "imports": {
            "@material/web/": "https://esm.run/@material/web/"
          }
        }
    </script>
    <script type="module">
        import '@material/web/all.js';
        import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

        document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>
</head>
<body>

<h1 id="login_title" class="md-typescale-display-medium"> Login </h1>
<form id="login_form" action="javascript:void(0);" method="post">
    <div class="form-group">
        <div style="display: flex; align-items: center; gap: 8px; padding-bottom: 16px;">
            <span class="material-icons">email</span>
            <md-outlined-text-field label="Email" type="email" id="login_email" required
                                    no-asterisk></md-outlined-text-field>
            <br/>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; padding-bottom: 16px;">
            <span class="material-icons">lock</span>
            <md-outlined-text-field label="Password" type="password" id="login_password" required
                                    no-asterisk></md-outlined-text-field>
            <br/>
        </div>

        <md-filled-button id="submit_login">Login</md-filled-button>
    </div>
</form>

<md-dialog id="error_dialog">
    <div slot="headline">
        Error
    </div>
    <form slot="content" id="form-id" method="dialog">
        <p class="md-typescale-body-medium" id="error_message"></p>
    </form>
    <div slot="actions">
        <md-text-button form="form-id">Ok</md-text-button>
    </div>
</md-dialog>

<md-circular-progress indeterminate id="loading_indicator" style="display: none;"></md-circular-progress>

<style>
    #login_title {
        justify-content: center;
        width: 50%;
        margin: auto;
        display: flex;
        flex-wrap: wrap;
        padding-bottom: 16px;
    }

    #login_form {
        justify-content: center;
        width: 50%;
        margin: auto;
        display: flex;
        flex-wrap: wrap;
    }

    #submit_login {
        justify-content: center;
        width: 50%;
        margin: auto;
        display: flex;
        flex-wrap: wrap;
    }

    #loading_indicator {
        justify-content: center;
        width: 50%;
        margin: auto;
        display: flex;
        flex-wrap: wrap;
    }
</style>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import {getFirestore} from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
    import {
        collection,
        getDocs,
        query,
        where
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
    import {
        getAuth,
        signInWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";

    window.onload = async () => {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.getElementById("submit_login").addEventListener("click", loginUser, false);

        async function loginUser() {
            const emailInput = document.querySelector("#login_email");
            const passwordInput = document.querySelector("#login_password");
            const loadingIndicator = document.getElementById("loading_indicator");

            emailInput.reportValidity();
            passwordInput.reportValidity();

            const emailValidityState = emailInput.validity;
            const passwordValidityState = passwordInput.validity;

            if (emailValidityState.typeMismatch) {
                emailInput.setCustomValidity("Invalid email address");
            }

            if (emailValidityState.valid && passwordValidityState.valid) {
                loadingIndicator.style.display = "block";

                const auth = getAuth();
                signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                    .then(async (userCredential) => {
                        // Signed in
                        const user = userCredential.user;
                        emailInput.value = "";
                        passwordInput.value = "";

                        if (user.emailVerified) {
                            const foundUsers = query(collection(db, "users"), where("auth_id", "==", user.uid));
                            const querySnapshot = await getDocs(foundUsers);
                            const firstUser = querySnapshot.docs[0].data();
                            navigate(firstUser.user_type);
                            loadingIndicator.style.display = "none";
                        } else {
                            await document.getElementById("error_dialog").show();
                            document.getElementById("error_message").innerHTML = "Please verify email!"
                        }
                    })
                    .catch((error) => {
                        const errorCode = error.code;
                        const errorMessage = error.message;
                        console.log("errorCode " + errorCode);
                        console.log("message=" + errorMessage);
                        handleLoginError(errorCode);
                        loadingIndicator.style.display = "none";
                    });
            }
        }

        async function handleLoginError(errorCode) {
            const errorDialog = document.getElementById("error_dialog");
            const errorMessage = document.getElementById("error_message");

            switch (errorCode) {
                case "auth/invalid-email":
                    await errorDialog.show();
                    errorMessage.innerHTML = "Invalid email";
                    break;

                case "auth/invalid-credential":
                    await errorDialog.show();
                    errorMessage.innerHTML = "Invalid credentials";
                    break;
            }
        }

        function navigate(userTypeText) {
            switch (userTypeText) {
                case "admin":
                    window.location.href = "admin/index.html";
                    break;

                case "trainer":
                    window.location.href = "trainer/index.html";
                    break;

                case "child":
                    window.location.href = "child/index.html";
                    break;

                case "parent":
                    window.location.href = "parent/index.html";
                    break;
            }
        }
    }
</script>
</body>